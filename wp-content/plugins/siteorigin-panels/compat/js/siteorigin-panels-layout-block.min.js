"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _createSuper(e){function t(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}return function(){var i,n=_getPrototypeOf(e);if(t()){var o=_getPrototypeOf(this).constructor;i=Reflect.construct(n,arguments,o)}else i=n.apply(this,arguments);return _possibleConstructorReturn(this,i)}}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var SiteOriginPanelsLayoutBlock=function(e){_inherits(i,wp.element.Component);var t=_createSuper(i);function i(e){var n;_classCallCheck(this,i),n=t.call(this,e);var o="object"===_typeof(e.panelsData)&&Object.keys(e.panelsData).length>0,r="edit"===window.soPanelsBlockEditorAdmin.defaultMode,a=!0!==o||r;return n.state={editing:a,loadingPreview:!a,previewHtml:"",previewInitialized:!a,pendingPreviewRequest:!1,panelsInitialized:!1},n.panelsContainer=wp.element.createRef(),n.previewContainer=wp.element.createRef(),n.fetchPreviewTimer,n}return _createClass(i,[{key:"componentDidMount",value:function(){if(this.isStillMounted=!0,this.state.panelsInitialized||this.setupPanels(),!this.previewInitialized){clearTimeout(this.fetchPreviewTimer);var e=this;this.fetchPreviewTimer=setTimeout((function(){e.fetchPreview(e.props)}),1e3)}}},{key:"componentWillUnmount",value:function(){this.isStillMounted=!1,this.builderView&&this.builderView.off("content_change")}},{key:"componentDidUpdate",value:function(e){if(this.state.panelsInitialized)if(this.state.loadingPreview){if(!this.state.pendingPreviewRequest){this.setState({pendingPreviewRequest:!0}),clearTimeout(this.fetchPreviewTimer);var t=this;this.fetchPreviewTimer=setTimeout((function(){t.fetchPreview(t.props)}),1e3)}}else this.state.previewInitialized||(jQuery(document).trigger("panels_setup_preview"),this.setState({previewInitialized:!0}));else this.setupPanels()}},{key:"setupPanels",value:function(){var e=this;if(!this.state.panelsInitialized){var t=jQuery(this.panelsContainer.current),i={editorType:"standalone",loadLiveEditor:!1,postId:window.soPanelsBlockEditorAdmin.postId,editorPreview:window.soPanelsBlockEditorAdmin.liveEditor},n=new panels.model.builder;this.builderView=new panels.view.builder({model:n,config:i});var o=JSON.parse(JSON.stringify(jQuery.extend({},this.props.panelsData))),r=function(){"function"==typeof e.props.onRowOrWidgetMouseDown&&e.props.onRowOrWidgetMouseDown();jQuery(document).on("mouseup",(function t(){jQuery(document).off("mouseup",t),"function"==typeof e.props.onRowOrWidgetMouseUp&&e.props.onRowOrWidgetMouseUp()}))};this.builderView.on("row_added",(function(){e.builderView.$(".so-row-move").off("mousedown",r),e.builderView.$(".so-row-move").on("mousedown",r),e.builderView.$(".so-widget").off("mousedown",r),e.builderView.$(".so-widget").on("mousedown",r)})),this.builderView.on("widget_added",(function(){e.builderView.$(".so-widget").off("mousedown",r),e.builderView.$(".so-widget").on("mousedown",r)})),this.builderView.render().attach({container:t}).setData(o),this.builderView.trigger("builder_resize");this.builderView.on("content_change",(function(){var t=e.builderView.getData();e.panelsDataChanged=!function e(t,i){if(t===i)return!0;if(!t||!i||"object"!==_typeof(t)&&"object"!==_typeof(i))return t===i;var n=Object.keys(t);return n.length===Object.keys(i).length&&n.every((function(n){return e(t[n],i[n])}))}(o,t),e.panelsDataChanged&&(e.props.onContentChange&&"function"==typeof e.props.onContentChange&&e.props.onContentChange(t),e.setState({loadingPreview:!0,previewHtml:""}))})),jQuery(document).trigger("panels_setup",this.builderView),void 0===window.soPanelsBuilderView&&(window.soPanelsBuilderView=[]),window.soPanelsBuilderView.push(this.builderView),this.setState({panelsInitialized:!0})}}},{key:"fetchPreview",value:function(e){var t=this;if(this.isStillMounted){var i=null===e.panelsData?this.builderView.getData():e.panelsData;this.setState({previewInitialized:!1});var n=this.currentFetchRequest=jQuery.post({url:window.soPanelsBlockEditorAdmin.previewUrl,data:{action:"so_panels_layout_block_preview",panelsData:JSON.stringify(i)}}).then((function(e){t.isStillMounted&&(setTimeout((function(){jQuery(document).trigger("panels_setup_preview")}),1e3),n===t.currentFetchRequest&&e&&t.setState({previewHtml:e,loadingPreview:!1,previewInitialized:!1,pendingPreviewRequest:!1}))}));return n}}},{key:"render",value:function(){var e=this,t=this.props.panelsData;return React.createElement(wp.element.Fragment,null,React.createElement(wp.blockEditor.BlockControls,null,React.createElement(wp.components.Toolbar,{label:wp.i18n.__("Page Builder Mode.","siteorigin-panels")},this.state.editing?React.createElement(wp.components.ToolbarButton,{icon:"visibility",className:"components-icon-button components-toolbar__control",label:wp.i18n.__("Preview layout.","siteorigin-panels"),onClick:function(){t&&e.setState({editing:!1})}}):React.createElement(wp.components.ToolbarButton,{icon:"edit",className:"components-icon-button components-toolbar__control",label:wp.i18n.__("Edit layout.","siteorigin-panels"),onClick:function(){e.setState({editing:!0});var t=e;setTimeout((function(){t.builderView.trigger("builder_resize")}))}}))),React.createElement("div",{key:"layout-block",className:"siteorigin-panels-layout-block-container",ref:this.panelsContainer,hidden:!this.state.editing}),React.createElement("div",{key:"preview",className:"so-panels-block-layout-preview-container",hidden:this.state.editing},this.state.loadingPreview?React.createElement("div",{className:"so-panels-spinner-container"},React.createElement("span",null,React.createElement(wp.components.Spinner,null))):React.createElement("div",{className:"so-panels-raw-html-container",ref:this.previewContainer},React.createElement(wp.element.RawHTML,null,this.state.previewHtml))))}}]),i}(),hasLayoutCategory=wp.blocks.getCategories().some((function(e){return"layout"===e.slug}));wp.blocks.registerBlockType("siteorigin-panels/layout-block",{title:wp.i18n.__("SiteOrigin Layout","siteorigin-panels"),description:wp.i18n.__("Build a layout using SiteOrigin's Page Builder.","siteorigin-panels"),icon:function(){return React.createElement("span",{className:"siteorigin-panels-block-icon"})},category:hasLayoutCategory?"layout":"design",keywords:["page builder","column,grid","panel"],supports:{html:!1},attributes:{panelsData:{type:"object"},contentPreview:{type:"string"}},edit:function(e){var t=e.attributes,i=e.setAttributes,n=e.toggleSelection;return React.createElement(SiteOriginPanelsLayoutBlock,{panelsData:t.panelsData,onContentChange:function(e){if("object"===_typeof(e.widgets)&&Object.keys(e.widgets).length>0){var t=jQuery(".widgets-php").length;t||wp.data.dispatch("core/editor").lockPostSaving(),jQuery.post(panelsOptions.ajaxurl,{action:"so_panels_builder_content_json",panels_data:JSON.stringify(e),post_id:t?"":wp.data.select("core/editor").getCurrentPostId()},(function(e){var n={};""!==e.sanitized_panels_data&&(n.panelsData=e.sanitized_panels_data),""!==e.preview&&(n.contentPreview=e.preview),i(n),t||wp.data.dispatch("core/editor").unlockPostSaving()}))}else i({panelsData:null,contentPreview:null})},onRowOrWidgetMouseDown:function(){n(!1)},onRowOrWidgetMouseUp:function(){n(!0)}})}}),jQuery((function(){var e=function(){var e=!1;return wp.data.select("core/block-editor")?e=wp.data.select("core/block-editor").hasInserterItems():wp.data.select("core/editor")&&(e=wp.data.select("core/editor").__unstableIsEditorReady()),e},t=null;t=wp.data.subscribe((function(){e()&&t&&(t(),setTimeout((function(){jQuery('.wp-block[data-type="siteorigin-panels/layout-block"].has-warning .block-editor-warning__action .components-button').trigger("click")}),250))}));var i=setInterval((function(){e()||(jQuery('.wp-block[data-type="siteorigin-panels/layout-block"].has-warning .block-editor-warning__action .components-button').trigger("click"),clearInterval(i))}),1500);window.soPanelsBlockEditorAdmin.showAddButton&&jQuery((function(){setTimeout((function(){var e=wp.data.dispatch("core/editor"),t=wp.data.select("core/editor"),i=jQuery("#siteorigin-panels-add-layout-block-button").html();if(jQuery(".block-editor-writing-flow > .block-editor-block-list__layout").length)var n=".block-editor-writing-flow > .block-editor-block-list__layout";else n=".editor-writing-flow > div:first, .block-editor-writing-flow > div:not([tabindex])";var o=jQuery(i).appendTo(n);o.on("click",(function(){var i=wp.blocks.createBlock("siteorigin-panels/layout-block",{});if(t.isEditedPostEmpty()){var n=t.getBlocks();n.length?e.replaceBlock(n[0].clientId,i):e.insertBlock(i)}else e.insertBlock(i)}));var r=function(){wp.data.select("core/editor").isEditedPostEmpty()?o.show():o.hide()};wp.data.subscribe(r),r()}),100)}))})),jQuery(document).on("click",".block-editor-post-preview__button-resize",(function(e){jQuery(this).hasClass("has-icon")||jQuery(window).trigger("resize")}));