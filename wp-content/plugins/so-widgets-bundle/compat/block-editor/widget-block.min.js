!async function(e,t,i,o,s){const n=i.createElement,r=e.registerBlockType,a=s.BlockControls,{Component:d,useMemo:l}=i,{Toolbar:c,ToolbarButton:g,Placeholder:w,Button:b,Spinner:u}=o,{__:p,sprintf:m}=t,{updateCategory:k}=e,h=e=>{let t="";return e.hasOwnProperty("responseJSON")?t=e.responseJSON.message:e.hasOwnProperty("responseText")&&(t=e.responseText),t},f=["sowb/siteorigin-widget-googlemap-widget","sowb/siteorigin-widget-icon-widget"],v=(e,t,i,o=!1,s=!1)=>{if(t)return;i({loadingWidgetPreview:!0,widgetPreviewHtml:null});const n="object"==typeof wp.data.select("core/editor")&&"object"==typeof wp.data.dispatch("core/editor");n&&wp.data.dispatch("core/editor").lockPostSaving();jQuery.post({url:sowbBlockEditorAdmin.restUrl+"sowb/v1/widgets/previews",beforeSend:e=>{e.setRequestHeader("X-WP-Nonce",sowbBlockEditorAdmin.nonce)},data:{anchor:e.attributes.anchor,widgetClass:s,widgetData:o||(e.attributes.widgetData||{})}}).done(t=>{let o=!1;t.html&&(o=!!f.includes(e.name)||(e=>{const t=jQuery("<div>"+e+"</div>");let i=!1;const o=t.find("div:first-of-type");return o.length>0&&(""!==o.text().trim()||o.find("img, video, a").length>0)&&(i=!0),t.remove(),i})(t.html)),o||(t.html='<div class="so-widget-preview-empty">'+p("No widget preview available.","so-widgets-bundle")+"</div>"),i({widgetPreviewHtml:t.html,previewInitialized:!1}),e.setAttributes({widgetMarkup:t.html,widgetIcons:t.widgetIcons})}).fail(e=>{i({widgetFormHtml:"<div>"+h(e)+"</div>"})}).always(()=>{n&&wp.data.dispatch("core/editor").unlockPostSaving(),i({loadingWidgetPreview:!1})})},y=({props:e,widget:t})=>l(()=>n(B,{...e,widget:t}),[e,t]);class B extends d{constructor(e){super(e),this.initialState={editing:void 0===e.attributes.widgetData,formInitialized:!1,loadingForm:!1,loadingWidgetPreview:!1,previewInitialized:!1,widgetFormHtml:"",widgetPreviewHtml:"",widgetSettingsChanged:!1,previewDebounceTimer:null},this.state={...this.initialState,isStillMounted:!0},e.attributes.widgetClass||this.props.setAttributes({widgetClass:e.widget.class})}componentDidMount(){this.setState({...this.initialState,isStillMounted:!0}),this.loadWidgetData()}componentWillUnmount(){this.setState({...this.initialState,isStillMounted:!1})}componentDidUpdate(e,t){this.state.isStillMounted&&(this.state.editing===t.editing&&this.props.attributes.widgetData===e.attributes.widgetData||(this.setState({widgetSettingsChanged:!0,widgetPreviewHtml:null,previewInitialized:!1}),this.loadWidgetData()))}loadWidgetData(){if(!this.state.isStillMounted)return;const{editing:e,widgetFormHtml:t,loadingForm:i,loadingWidgetPreview:o}=this.state,{attributes:s}=this.props;if(e||!s.widgetData){return void(!t.length&&!i&&(this.setState({loadingForm:!0}),jQuery.post({url:sowbBlockEditorAdmin.restUrl+"sowb/v1/widgets/forms",beforeSend:e=>{e.setRequestHeader("X-WP-Nonce",sowbBlockEditorAdmin.nonce)},data:{widgetClass:this.props.widget.class,widgetData:s.widgetData}}).done(e=>{this.setState({widgetFormHtml:e}),setTimeout(()=>{this.setState({loadingForm:!1,formInitialized:!1})},0)}).fail(e=>{this.setState({widgetFormHtml:"<div>"+h(e)+"</div>"})})))}!o&&!e&&(this.props.setAttributes({widgetMarkup:null,widgetIcons:null}),v(this.props,this.state.loadingWidgetPreview,this.setState.bind(this),!1,this.props.widget.class))}render(){const{editing:e,widgetFormHtml:t,loadingForm:i,widgetPreviewHtml:o,loadingWidgetPreview:s,previewInitialized:r}=this.state,{attributes:d}=this.props;return n("div",null,e||!d.widgetData?[!!t&&n(a,{key:"controls"},n(c,{label:p("Preview widget."+e,"so-widgets-bundle")},n(g,{className:"components-icon-button components-toolbar__control",label:p("Preview widget.","so-widgets-bundle"),onClick:()=>this.setState({editing:!1}),icon:"visibility"}))),n(w,{key:"placeholder",className:"so-widget-block-form",label:this.props.widget.name,instructions:this.props.widget.description},i?n("div",{className:"so-widgets-spinner-container"},n("span",null,n(u))):n("div",{className:"so-widget-block-container",dangerouslySetInnerHTML:{__html:t},ref:()=>((e,t,i)=>{const o=jQuery('[data-block="'+e.clientId+'"]').find(".siteorigin-widget-form-main");if(o.length>0&&!t.formInitialized){o.siblings(".siteorigin-widget-preview").find("> a").on("click",(function(e){e.stopImmediatePropagation(),i({editing:!1,previewInitialized:!1,widgetPreviewHtml:!1})})),o.data("backupDisabled",!0),e.attributes.widgetData?sowbForms.setWidgetFormValues(o,e.attributes.widgetData):e.setAttributes({widgetData:sowbForms.getWidgetFormValues(o)}),o.sowSetupForm(),o.on("change",(function(){var s=sowbForms.getWidgetFormValues(o);e.setAttributes({widgetData:s}),clearTimeout(t.previewDebounceTimer),t.previewDebounceTimer=setTimeout(()=>{v(e,t.loadingWidgetPreview,i,s,e.widget.class)},300)})),i({formInitialized:!0})}})(this.props,this.state,this.setState.bind(this),this.props.widget.class)}))]:[n(a,{key:"controls"},n(c,{label:p("Edit widget.","so-widgets-bundle")},n(g,{className:"components-icon-button components-toolbar__control",label:p("Edit widget.","so-widgets-bundle"),onClick:()=>this.setState({editing:!0,loadingForm:!1,widgetFormHtml:"",formInitialized:!1}),icon:"edit"}))),n("div",{key:"preview",className:"so-widget-preview-container"},s?n("div",{className:"so-widgets-spinner-container"},n("span",null,n(u))):n("div",{dangerouslySetInnerHTML:{__html:o},ref:()=>{r||(jQuery(window.sowb).trigger("setup_widgets",{preview:!0}),this.setState({previewInitialized:!0}))}}))])}}r("sowb/widget-block",{title:p("SiteOrigin Widgets Block","so-widgets-bundle"),description:p("This block is intended as a legacy placeholder.","so-widgets-bundle"),attributes:{widgetClass:{type:"string"},anchor:{type:"string"},widgetData:{type:"object"},widgetMarkup:{type:"string"},widgetIcons:{type:"array"},widgetNotFound:{type:"boolean"}},supports:{inserter:!1},icon:function(){return n("span",{className:"widget-icon so-widget-icon so-block-editor-icon so-widget-icon-default"})},edit:function(e){const[t,o]=i.useState(!1),[s,r]=i.useState(!0);return i.useEffect(()=>{I().then(e=>{o(e),r(!1)})},[]),e.attributes.widgetNotFound?n(w,{label:p("SiteOrigin Widget","so-widgets-bundle"),className:"so-widget-block-form"},n("p",null,m(p("The widget for %s cannot be found.","so-widgets-bundle"),e.attributes.widgetClass))):s?n("div",{className:"so-widget-block-form so-widgets-spinner-container"},n("span",null,n(u))):n("div",{className:"so-widget-block-form"},n(w,{label:p("Legacy SiteOrigin Widget","so-widgets-bundle")},n("p",{dangerouslySetInnerHTML:{__html:sowbBlockEditorAdmin.legacyNotice}}),t?n(b,{isPrimary:!0,onClick:()=>{r(!0),setTimeout(()=>{sowbBlockEditorAdmin.consent=!0,sowbBlockEditorAdmin.consentGiven=!0,sowbMigrateOldBlocks()},0),jQuery.post(ajaxurl,{action:"so_widgets_block_migration_notice_consent",nonce:sowbBlockEditorAdmin.migrationNotice})}},p("Migrate to New Block Format","so-widgets-bundle")):n("span",null,p("Please contact your site administrator to migrate this block.","so-widgets-bundle"))))},save:function(){return null}});let S=null;const I=()=>(null!==S||(S=new Promise((e,t)=>{jQuery.post({url:sowbBlockEditorAdmin.restUrl+"sowb/v1/widgets/permission",beforeSend:e=>{e.setRequestHeader("X-WP-Nonce",sowbBlockEditorAdmin.nonce)}}).done(t=>{e(t)}).fail(t=>{console.error("Failed to check admin permissions:",t),e(!1)})})),S),F={},P=[...Object.values(sowbBlockEditorAdmin.widgets)];await Promise.all(Object.entries(P).map(async([e,t])=>{(async(e,t)=>{if(e.blockName)return void 0!==e.manuallyRegister&&e.manuallyRegister?(F[e.blockName]=e,void delete P[t]):void 0;delete P[t]})(t,e)})),await soRegisterWidgetBlocks(F),Object.entries(F).forEach(([e,t])=>{wp.hooks.addFilter("blocks.registerBlockType","sowb/"+t.blockName,(function(e,i){return i!=="sowb/"+t.blockName?e:{...e,icon:function(){return t.icon?n("img",{className:"widget-icon so-widget-icon so-block-editor-icon",src:t.icon,alt:t.name}):n("span",{className:"widget-icon so-widget-icon so-block-editor-icon so-widget-icon-default"})},keywords:t.keywords?t.keywords:"",category:"siteorigin",supports:{html:!1,anchor:!0},edit:e=>n(y,{props:e,widget:t})}}))});await P.forEach(e=>{r("sowb/"+e.blockName,{title:e.name,description:e.description,icon:function(){return e.icon?n("img",{className:"widget-icon so-widget-icon so-block-editor-icon",src:e.icon,alt:e.name}):n("span",{className:"widget-icon so-widget-icon so-block-editor-icon so-widget-icon-default"})},category:"siteorigin",keywords:e.keywords?e.keywords:"",supports:{html:!1,anchor:!0},attributes:{widgetClass:{type:"string"},anchor:{type:"string"},widgetData:{type:"object"},widgetMarkup:{type:"string"},widgetIcons:{type:"array"}},edit:t=>n(y,{props:t,widget:e}),save:function(e){return null}})}),k("siteorigin",{icon:n("img",{src:sowbBlockEditorAdmin.categoryIcon,alt:p("SiteOrigin Widgets Bundle Blocks Category","so-widgets-bundle"),style:{height:"20px",width:"20px"}})})}(window.wp.blocks,window.wp.i18n,window.wp.element,window.wp.components,window.wp.blockEditor);const sowbFindLegacyBlocks=e=>e.reduce((e,t)=>{if("core/widget-area"===t.name){return wp.data.select("core/block-editor").getBlocks(t.clientId).forEach(t=>{"sowb/widget-block"===t.name&&e.push(t)}),e}return"sowb/widget-block"===t.name&&e.push(t),t.innerBlocks&&t.innerBlocks.length>0&&e.push(...sowbFindLegacyBlocks(t.innerBlocks)),e},[]),sowbIsWidgetActive=e=>sowbBlockEditorAdmin.widgets.find(t=>t.class===e);let sowbMigrateBlockSubscribe=!1,sowbMigrationInProgress=!1;const sowbMigrateOldBlocks=()=>{if(!0===sowbMigrationInProgress)return;const e=wp.data.select("core/block-editor").getBlocks();if(0===e.length)return;const t=sowbFindLegacyBlocks(e);if(0!==t.length){if(sowbBlockEditorAdmin.consent){sowbMigrationInProgress=!0;try{t.forEach(e=>{try{if(t=e.attributes.widgetClass,!sowbBlockEditorAdmin.widgets.find(e=>e.class===t)){const t={...e.attributes};return t.widgetNotFound=!0,void wp.data.dispatch("core/block-editor").updateBlock(e.clientId,{attributes:t})}const i=wp.blocks.createBlock("sowb/"+e.attributes.widgetClass.toLowerCase().replace(/_/g,"-"),e.attributes);i&&wp.data.dispatch("core/block-editor").replaceBlock(e.clientId,i)}catch(e){console.error("SiteOrigin Widget Block migration failed:",e)}var t})}finally{setTimeout(()=>{sowbMigrationInProgress=!1},100)}return!sowbBlockEditorAdmin.consentGiven&&sowbRemoveLegacyWidgetBlock()}"function"==typeof sowbMigrateBlockSubscribe&&sowbMigrateBlockSubscribe()}},sowbRemoveLegacyWidgetBlock=()=>(setTimeout(()=>{"function"==typeof sowbMigrateBlockSubscribe&&sowbMigrateBlockSubscribe()},0),!1),sowbIsMissingBlockSowb=e=>"core/missing"===e.name&&e.isValid&&e.attributes&&e.attributes.originalName.startsWith("sowb/"),sowbFindInactiveBlock=e=>e.reduce((e,t)=>{if("core/widget-area"===t.name){return wp.data.select("core/block-editor").getBlocks(t.clientId).forEach(t=>{sowbIsMissingBlockSowb(t)&&e.push(t)}),e}return sowbIsMissingBlockSowb(t)&&e.push(t),t.innerBlocks&&t.innerBlocks.length>0&&e.push(...sowbFindInactiveBlock(t.innerBlocks)),e},[]);if(jQuery((function(e){if(!e("body.block-editor-page").length)return;sowbBlockEditorAdmin.consent&&(sowbMigrateBlockSubscribe=wp.data.subscribe(sowbMigrateOldBlocks));const t=wp.data.subscribe(()=>{const e=wp.data.select("core/block-editor").getBlocks();if(0===e.length)return;const i=sowbFindInactiveBlock(e);i.length&&(setTimeout(()=>{(e=>{e.forEach(e=>{const t=document.querySelector(`[data-block="${e.clientId}"] .block-editor-warning__message`);t&&(t.innerHTML=sprintf(wp.i18n.__('The "%s" block is currently not available. The plugin or theme that powers the block might be deactivated or not installed. You can leave it as is or remove it. %sRead our troubleshooting guide for more details%s.',"so-widgets-bundle"),`<strong>${e.attributes.originalName}</strong>`,'<a href="https://siteorigin.com/widgets-bundle/troubleshooting/" target="_blank" rel="noopener noreferrer">',"</a>"))})})(i)},0),t())})})),"undefined"!=typeof adminpage&&"widgets-php"!=adminpage&&"function"==typeof wp.data.select){let e=!1;wp.data.subscribe((function(){if(!e&&"object"==typeof wp.data.select("core/editor")&&wp.data.select("core/editor").isSavingPost()){e=!0;var t=setInterval((function(){if(!wp.data.select("core/editor").isSavingPost()&&!wp.data.select("core/editor").isAutosavingPost()&&wp.data.select("core/editor").didPostSaveRequestSucceed()){clearInterval(t);for(var i=!0,o=wp.data.select("core/block-editor").getBlocks(),s=0;s<o.length;s++)o[s].name.startsWith("sowb/")&&o[s].isValid&&($form=jQuery("#block-"+o[s].clientId).find(".so-widget-block-form"),sowbForms.validateFields($form,i)||(i=!1),$form.find(".siteorigin-widget-field-is-required input").on("change",(function(){sowbForms.validateFields($form)})));e=!1}}),250)}}))}